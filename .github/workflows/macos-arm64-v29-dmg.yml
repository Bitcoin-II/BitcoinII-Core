name: macOS arm64 .dmg (v29.1.0, CMake)

on:
  workflow_dispatch:

jobs:
  build-dmg-v029:
    runs-on: macos-14  # Apple Silicon runner

    env:
      TARGET_TAG: v29.1.0

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Checkout release tag
        run: |
          git fetch --tags
          echo "Checking out tag $TARGET_TAG..."
          git checkout "$TARGET_TAG"
          git submodule update --init --recursive || true

      - name: Show environment info
        run: |
          uname -a
          sw_vers
          sysctl -n hw.logicalcpu || true

      - name: Install build dependencies (Homebrew)
        run: |
          brew update

          brew install \
            cmake \
            automake \
            libtool \
            pkg-config \
            boost \
            libevent \
            qrencode \
            sqlite \
            zeromq \
            berkeley-db@4 \
            qt@5

          # Make Qt5 tools visible (qmake, macdeployqt, etc.)
          echo "$(brew --prefix qt@5)/bin" >> "$GITHUB_PATH"

      - name: Configure with CMake (v0.29.1, GUI + wallet + ZMQ + BDB + USDT)
        run: |
          mkdir -p build
          cd build

          BDB_PREFIX="$(brew --prefix berkeley-db@4)"
          ZMQ_PREFIX="$(brew --prefix zeromq)"

          cmake .. \
            -DCMAKE_BUILD_TYPE=Release \
            -DBUILD_GUI=ON \
            -DENABLE_WALLET=ON \
            -DWITH_BDB=ON \
            -DWITH_ZMQ=ON \
            -DWITH_USDT=OFF \
            -DWITH_QRENCODE=ON \
            -DBerkeleyDB_ROOT="${BDB_PREFIX}" \
            -DZMQ_INCLUDE_DIR="${ZMQ_PREFIX}/include" \
            -DZMQ_LIBRARY="${ZMQ_PREFIX}/lib/libzmq.dylib"


      - name: Build (CMake)
        run: |
          cd build
          CORES="$(sysctl -n hw.logicalcpu || echo 4)"
          echo "Building with $CORES cores"

          # Adjust target name if your Qt GUI target is called something else
          cmake --build . --target bitcoinII-qt -j"$CORES" || \
          cmake --build . -j"$CORES"

      - name: Create .app bundle and .dmg with macdeployqt
        run: |
          cd build

          # Sanity: make sure we have the compiled binary
          if [ ! -f "bin/bitcoinII-qt" ]; then
            echo "bin/bitcoinII-qt not found, listing bin/:"
            ls -l bin || true
            exit 1
          fi

          # Create a minimal .app bundle structure
          APP_DIR="dist/BitcoinII-Qt.app"
          mkdir -p "$APP_DIR/Contents/MacOS"
          mkdir -p "$APP_DIR/Contents/Resources"

          # Copy the binary into the bundle and name it like the app
          cp bin/bitcoinII-qt "$APP_DIR/Contents/MacOS/BitcoinII-Qt"
          chmod +x "$APP_DIR/Contents/MacOS/BitcoinII-Qt"

          # Write a simple Info.plist
          cat > "$APP_DIR/Contents/Info.plist" <<EOF
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
            <key>CFBundleName</key>
            <string>BitcoinII-Qt</string>
            <key>CFBundleDisplayName</key>
            <string>BitcoinII-Qt</string>
            <key>CFBundleExecutable</key>
            <string>BitcoinII-Qt</string>
            <key>CFBundleIdentifier</key>
            <string>org.bitcoin-ii.BitcoinII-Qt</string>
            <key>CFBundlePackageType</key>
            <string>APPL</string>
            <key>CFBundleVersion</key>
            <string>${TARGET_TAG}</string>
            <key>CFBundleShortVersionString</key>
            <string>${TARGET_TAG}</string>
            <key>NSPrincipalClass</key>
            <string>NSApplication</string>
          </dict>
          </plist>
          EOF

          echo "Created app bundle at: $APP_DIR"
          find "$APP_DIR" -maxdepth 3 -print

          # Run macdeployqt on our bundle
          MACDEPLOYQT="$(command -v macdeployqt || true)"
          if [ -z "$MACDEPLOYQT" ]; then
            echo "macdeployqt not found in PATH"
            exit 1
          fi

          "$MACDEPLOYQT" "$APP_DIR" -dmg -always-overwrite

          echo "Generated DMG files:"
          find dist -maxdepth 2 -name '*.dmg' -print || true

      - name: Upload .dmg artifacts
        uses: actions/upload-artifact@v4
        with:
          name: bitcoinII-core-v29.1.0-macos-arm64-dmg
          path: |
            build/dist/*.dmg
          if-no-files-found: error

